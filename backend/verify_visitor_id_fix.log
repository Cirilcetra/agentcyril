2025-03-27 14:32:21,960 [INFO] Starting verification of visitor ID fix
2025-03-27 14:32:21,960 [INFO] ✅ Environment variables verified
2025-03-27 14:32:21,983 [INFO] ✅ Connected to Supabase
2025-03-27 14:32:21,984 [INFO] Checking database schema...
2025-03-27 14:32:22,398 [INFO] HTTP Request: GET https://byddvbuzcgegasqeyuuc.supabase.co/rest/v1/information_schema.columns?select=table_name%2Ccolumn_name%2Cdata_type&table_name=in.%28visitors%2Cmessages%29&column_name=in.%28id%2Cvisitor_id%2Cvisitor_id_text%29 "HTTP/2 404 Not Found"
2025-03-27 14:32:22,398 [ERROR] ❌ Error checking schema: {'code': '42P01', 'details': None, 'hint': None, 'message': 'relation "public.information_schema.columns" does not exist'}
2025-03-27 14:32:22,401 [ERROR] Traceback (most recent call last):
  File "/Users/cirilcyriacmullasseril/Documents/Experiments/agentcyril/backend/verify_visitor_id_fix.py", line 41, in check_schema
    ).in_("table_name", ["visitors", "messages"]).in_("column_name", ["id", "visitor_id", "visitor_id_text"]).execute()
                                                                                                              ^^^^^^^^^
  File "/Users/cirilcyriacmullasseril/.pyenv/versions/3.11.9/lib/python3.11/site-packages/postgrest/_sync/request_builder.py", line 78, in execute
    raise APIError(r.json())
postgrest.exceptions.APIError: {'code': '42P01', 'details': None, 'hint': None, 'message': 'relation "public.information_schema.columns" does not exist'}

2025-03-27 14:32:22,401 [INFO] Testing visitor ID flow...
2025-03-27 14:32:22,401 [INFO] Generated frontend visitor ID: v_0fb9f40aa9fb
2025-03-27 14:32:22,473 [INFO] HTTP Request: POST https://byddvbuzcgegasqeyuuc.supabase.co/rest/v1/visitors "HTTP/2 201 Created"
2025-03-27 14:32:22,476 [INFO] ✅ Created visitor with frontend ID 'v_0fb9f40aa9fb' and UUID '0c659088-0216-4bd1-9504-0a8fe1657278'
2025-03-27 14:32:22,540 [INFO] HTTP Request: GET https://byddvbuzcgegasqeyuuc.supabase.co/rest/v1/chatbots?select=id&limit=1 "HTTP/2 200 OK"
2025-03-27 14:32:22,540 [INFO] Using chatbot ID: a9c03dad-2a1f-4aec-816e-f3aed88158a8
2025-03-27 14:32:22,609 [INFO] HTTP Request: POST https://byddvbuzcgegasqeyuuc.supabase.co/rest/v1/messages "HTTP/2 201 Created"
2025-03-27 14:32:22,610 [INFO] ✅ Created message with ID: f94f9973-2afe-442b-a771-45dd80bb8cfe
2025-03-27 14:32:22,675 [INFO] HTTP Request: GET https://byddvbuzcgegasqeyuuc.supabase.co/rest/v1/messages?select=%2A&visitor_id_text=eq.v_0fb9f40aa9fb "HTTP/2 200 OK"
2025-03-27 14:32:22,676 [INFO] ✅ Retrieved message by visitor_id_text: f94f9973-2afe-442b-a771-45dd80bb8cfe
2025-03-27 14:32:22,744 [INFO] HTTP Request: POST https://byddvbuzcgegasqeyuuc.supabase.co/rest/v1/rpc/query "HTTP/2 404 Not Found"
2025-03-27 14:32:22,750 [ERROR] ❌ Error testing visitor ID flow: {'code': 'PGRST202', 'details': 'Searched for the function public.query with parameter query_text or with a single unnamed json/jsonb parameter, but no matches were found in the schema cache.', 'hint': None, 'message': 'Could not find the function public.query(query_text) in the schema cache'}
2025-03-27 14:32:22,762 [ERROR] Traceback (most recent call last):
  File "/Users/cirilcyriacmullasseril/Documents/Experiments/agentcyril/backend/verify_visitor_id_fix.py", line 168, in test_visitor_id_flow
    join_response = supabase.rpc('query', {"query_text": join_query}).execute()
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/cirilcyriacmullasseril/.pyenv/versions/3.11.9/lib/python3.11/site-packages/postgrest/_sync/request_builder.py", line 127, in execute
    raise APIError(r.json())
postgrest.exceptions.APIError: {'code': 'PGRST202', 'details': 'Searched for the function public.query with parameter query_text or with a single unnamed json/jsonb parameter, but no matches were found in the schema cache.', 'hint': None, 'message': 'Could not find the function public.query(query_text) in the schema cache'}

2025-03-27 14:32:22,776 [ERROR] ❌ Verification failed. Please fix the issues and try again.
2025-03-27 14:32:22,776 [ERROR] ❌ Database schema issues detected.
2025-03-27 14:32:22,778 [ERROR] ❌ Visitor ID flow issues detected.
